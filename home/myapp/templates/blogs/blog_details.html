{% extends 'base.html' %}
{% load static %}
{% load i18n %}

{% block title %}{{ post.title }} - {% trans "Wecamp Blog" %}{% endblock %}

{% block content %}
<style>
.toc-level-2 { margin-left: 0; }
.toc-level-3 { margin-left: 20px; }
</style>

  <!-- Page Title -->
  <div class="page-title dark-background" data-aos="fade">
    <style>
        .page-title {
          background-image: url('{% static "assets/img/travel/showcase-8.webp" %}');
        }
    </style>
    <div class="container position-relative">
      <h1>{% trans "Chi Tiết Bài Viết" %}</h1>
      <p>{% trans "Khám phá những câu chuyện và trải nghiệm tại Wecamp." %}</p>
      <nav class="breadcrumbs">
        <ol>
          <li><a href="{% url 'index' %}">{% trans "Trang Chủ" %}</a></li>
          <li><a href="{% url 'blog' %}">{% trans "Blog" %}</a></li>
          <li class="current">{% trans "Chi Tiết" %}</li>
        </ol>
      </nav>
    </div>
  </div><!-- End Page Title -->

  <!-- Blog Details Section -->
  <section id="blog-details" class="blog-details section">
    <div class="container" data-aos="fade-up">

      <article class="article">
        <div class="article-header">
          <div class="meta-categories" data-aos="fade-up">
            <a href="#" class="category">{{ post.get_category_display }}</a>
          </div>

          <h1 class="title clamp-3-lines" data-aos="fade-up" data-aos-delay="100">
            {{ post.title }}
          </h1>

          <div class="article-meta" data-aos="fade-up" data-aos-delay="200">
            <div class="author">
              {% if post.author_image %}
              <img src="{{ post.author_image.url }}" alt="{{ post.author_name }}" class="author-img">
              {% else %}
              <img src="{% static 'assets/img/person/default-avatar.webp' %}" alt="{% trans 'Avatar' %}" class="author-img">
              {% endif %}
              <div class="author-info">
                <h4>{{ post.author_name }}</h4>
                <span>{% trans "Người đăng bài" %}</span>
              </div>
            </div>
            <div class="post-info">
              <span><i class="bi bi-calendar4-week"></i> {{ post.published_at|date:"d/m/Y" }}</span>
              <span><i class="bi bi-clock"></i> 
                {% with words=post.content|striptags|wordcount %}
                  {% if words < 400 %}1-2{% elif words < 800 %}3-4{% elif words < 1200 %}5-6{% elif words < 1600 %}7-8{% else %}9+{% endif %}
                  {% trans "phút đọc" %}
                {% endwith %}
              </span>
              <span><i class="bi bi-chat-square-text"></i> 0 {% trans "Bình luận" %}</span>
            </div>
          </div>
        </div>

        <div class="article-featured-image" data-aos="zoom-in">
          <img src="{{ post.image.url }}" alt="{{ post.title }}" class="img-fluid">
        </div>

        <div class="article-wrapper">
          <!-- Table of Contents -->
          <aside class="table-of-contents" data-aos="fade-left">
            <h3>{% trans "Mục Lục" %}</h3>
            {% if post.get_table_of_contents %}
            <nav>
              <ul>
                {% for item in post.get_table_of_contents %}
                <li class="toc-level-{{ item.level }}">
                  <a href="#{{ item.slug }}" class="toc-link">{{ item.title|safe }}</a>
                </li>
                {% endfor %}
              </ul>
            </nav>
            {% else %}
            <p class="text-muted small">{% trans "Không có mục lục." %}</p>
            {% endif %}
          </aside>

          <!-- Nội dung bài viết -->
          <div class="article-content">
            {{ post.get_content_with_ids|safe }}
          </div>

          <!-- Footer: Share + Tags -->
          <div class="article-footer" data-aos="fade-up">
            <div class="share-article">
              <h4>{% trans "Chia sẻ bài viết" %}</h4>
              <div class="share-buttons">
                <a href="https://twitter.com/intent/tweet?url={{ request.build_absolute_uri }}&text={{ post.title }}" target="_blank" class="share-button twitter">
                  <i class="bi bi-twitter-x"></i>
                  <span>Twitter</span>
                </a>
                <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" class="share-button facebook">
                  <i class="bi bi-facebook"></i>
                  <span>Facebook</span>
                </a>
                <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.build_absolute_uri }}" target="_blank" class="share-button linkedin">
                  <i class="bi bi-linkedin"></i>
                  <span>LinkedIn</span>
                </a>
              </div>
            </div>

            <div class="article-tags">
              <h4>{% trans "Chủ đề liên quan" %}</h4>
              <div class="tags">
                <a href="#" class="tag">{{ post.get_category_display }}</a>
                <a href="#" class="tag">Wecamp</a>
                <a href="#" class="tag">{% trans "Du lịch" %}</a>
              </div>
            </div>
          </div>
        </article>

      </div>
    </section><!-- /Blog Details Section -->

    <!-- JS: TOC Scroll -->
    <script>
    document.addEventListener('DOMContentLoaded', function () {
      // TOC Smooth Scroll + Active Highlight
      document.querySelectorAll('.toc-link').forEach(link => {
        link.addEventListener('click', function (e) {
          e.preventDefault();
          const target = document.querySelector(this.getAttribute('href'));
          if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
            document.querySelectorAll('.toc-link').forEach(l => l.classList.remove('active'));
            this.classList.add('active');
          }
        });
      });

      // Highlight TOC khi scroll
      window.addEventListener('scroll', function () {
        const headings = document.querySelectorAll('h2[id], h3[id]');
        const tocLinks = document.querySelectorAll('.toc-link');
        let current = '';

        headings.forEach(h => {
          if (h.getBoundingClientRect().top < 180) {
            current = h.id;
          }
        });

        tocLinks.forEach(link => {
          link.classList.remove('active');
          if (link.getAttribute('href') === `#${current}`) {
            link.classList.add('active');
          }
        });
      });
    });
    </script>

    <style>
    .toc-link {
      display: block;
      color: #666;
      text-decoration: none;
      font-size: 0.95rem;
      padding: 4px 0;
      transition: all 0.2s;
    }
    .toc-link:hover, .toc-link.active {
      color: #007bff;
      font-weight: 500;
      padding-left: 4px;
    }
    .table-of-contents ul {
      list-style: none;
      padding-left: 0;
      margin: 0;
    }
    #back-to-top {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 45px;
      height: 45px;
      border-radius: 50%;
      background: #007bff;
      color: white;
      border: none;
      font-size: 1.2rem;
      display: none;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.3s;
    }
    #back-to-top:hover {
      background: #0056b3;
      transform: translateY(-3px);
    }
    </style>

  </section>

{% endblock %}
